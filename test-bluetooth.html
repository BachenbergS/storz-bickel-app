<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Web Bluetooth Test</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, sans-serif; margin: 20px; }
    h1 { margin-bottom: 8px; }
    .row { margin: 8px 0; }
    button { padding: 8px 12px; margin-right: 8px; }
    #log { white-space: pre-wrap; background: #f5f5f5; border: 1px solid #ddd; padding: 12px; min-height: 160px; }
    code { background: #eee; padding: 2px 4px; }
  </style>
</head>
<body>
  <h1>Web Bluetooth Test</h1>
  <p>Dieser Test prüft, ob Web Bluetooth im aktuellen Browserfenster verfügbar ist und zeigt ggf. die Gerätauswahl.</p>

  <div class="row">
    <button id="btnAvail">Verfügbarkeit prüfen</button>
    <button id="btnReq">Gerät anfordern (acceptAllDevices)</button>
    <button id="btnScan">LE Scan starten (falls verfügbar)</button>
  </div>

  <div class="row">
    <strong>Status:</strong> <span id="status">unbekannt</span>
  </div>

  <div class="row">
    <div id="log"></div>
  </div>

  <script>
    const statusEl = document.getElementById('status');
    const logEl = document.getElementById('log');
    function log(...args) {
      console.log(...args);
      logEl.textContent += args.map(a => typeof a === 'string' ? a : JSON.stringify(a, null, 2)).join(' ') + "\n";
    }

    function setStatus(text) { statusEl.textContent = text; }

    async function checkAvailability() {
      try {
        if (!('bluetooth' in navigator)) {
          setStatus('navigator.bluetooth fehlt');
          log('navigator.bluetooth nicht vorhanden');
          return;
        }
        const avail = await navigator.bluetooth.getAvailability();
        setStatus(avail ? 'verfügbar' : 'NICHT verfügbar');
        log('getAvailability:', avail);
      } catch (e) {
        setStatus('Fehler bei getAvailability');
        log('Fehler getAvailability:', e);
      }
    }

    async function requestDevice() {
      try {
        if (!('bluetooth' in navigator)) {
          setStatus('navigator.bluetooth fehlt');
          log('navigator.bluetooth nicht vorhanden');
          return;
        }
        log('öffne Gerätauswahl ...');
        const device = await navigator.bluetooth.requestDevice({ acceptAllDevices: true, optionalServices: [0x1800, 0x1801, 0x180A] });
        log('Gerät gewählt:', { name: device?.name, id: device?.id });
        setStatus('Gerät gewählt: ' + (device?.name || device?.id || 'unbekannt'));
      } catch (e) {
        log('requestDevice Fehler/abgebrochen:', e);
        setStatus('Geräteauswahl abgebrochen/Fehler');
      }
    }

    let activeScan = null;
    async function startScan() {
      try {
        if (!navigator.bluetooth || !navigator.bluetooth.requestLEScan) {
          log('requestLEScan nicht verfügbar');
          setStatus('LE Scan nicht verfügbar');
          return;
        }
        log('Starte LE Scan ...');
        activeScan = await navigator.bluetooth.requestLEScan({ keepRepeatedDevices: true });
        setStatus('LE Scan aktiv');
      } catch (e) {
        log('requestLEScan Fehler:', e);
        setStatus('LE Scan Fehler');
      }
    }

    document.getElementById('btnAvail').addEventListener('click', checkAvailability);
    document.getElementById('btnReq').addEventListener('click', requestDevice);
    document.getElementById('btnScan').addEventListener('click', startScan);

    // Automatisch zunächst Verfügbarkeit prüfen
    checkAvailability();
  </script>
</body>
</html>
