name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

# Verhindert parallele Builds desselben Tags
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-packages:
    name: Build ${{ matrix.format }} Package
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        format: [deb, rpm]
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.22.0'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci --ignore-scripts

      - name: Build ${{ matrix.format }}
        run: npm run build:${{ matrix.format }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload ${{ matrix.format }} Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.format }}-package
          path: dist/*.${{ matrix.format }}
          retention-days: 1

  build-flatpak:
    name: Build Flatpak Bundle
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Get Version
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Cache Flatpak Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.local/share/flatpak
            .flatpak-builder
          key: flatpak-${{ runner.os }}-${{ hashFiles('flatpak/org.storzbickel.app.yml') }}
          restore-keys: |
            flatpak-${{ runner.os }}-

      - name: Setup Flatpak
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder
          flatpak remote-add --user --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
          flatpak install --user -y flathub org.freedesktop.Platform//23.08 org.freedesktop.Sdk//23.08
          flatpak install --user -y flathub org.electronjs.Electron2.BaseApp//23.08

      - name: Build Flatpak
        run: |
          flatpak-builder --repo=repo --force-clean build-dir flatpak/org.storzbickel.app.yml
          flatpak build-bundle repo storz-bickel-app-${{ steps.version.outputs.version }}.flatpak org.storzbickel.app

      - name: Upload Flatpak Artifact
        uses: actions/upload-artifact@v4
        with:
          name: flatpak-bundle
          path: '*.flatpak'
          retention-days: 1

  create-release:
    name: Create GitHub Release
    needs: [build-packages, build-flatpak]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Get Version
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Extract Changelog
        id: changelog
        run: |
          # Extrahiere Changelog f√ºr diese Version
          VERSION="${{ steps.version.outputs.version }}"
          CHANGELOG=$(awk "/## \[$VERSION\]/,/## \[/" docs/CHANGELOG.md | sed '1d;$d' | sed '/^$/d')
          
          # Fallback wenn keine spezifische Version gefunden
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="Siehe [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/docs/CHANGELOG.md) f√ºr Details."
          fi
          
          # Speichere f√ºr GitHub Output (escape newlines)
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Download DEB Artifact
        uses: actions/download-artifact@v4
        with:
          name: deb-package
          path: dist/

      - name: Download RPM Artifact
        uses: actions/download-artifact@v4
        with:
          name: rpm-package
          path: dist/

      - name: Download Flatpak Artifact
        uses: actions/download-artifact@v4
        with:
          name: flatpak-bundle
          path: ./

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          draft: true
          generate_release_notes: false
          files: |
            dist/*.deb
            dist/*.rpm
            *.flatpak
          body: |
            ## üéâ Release v${{ steps.version.outputs.version }}

            ### üìù √Ñnderungen

            ${{ steps.changelog.outputs.content }}

            ---

            ### üì¶ Installation

            #### DEB (Debian/Ubuntu)
            ```bash
            sudo dpkg -i storz-bickel-app_${{ steps.version.outputs.version }}_amd64.deb
            ```

            #### RPM (Fedora/RHEL)
            ```bash
            sudo rpm -i storz-bickel-app-${{ steps.version.outputs.version }}.x86_64.rpm
            ```

            #### Flatpak
            ```bash
            flatpak install storz-bickel-app-${{ steps.version.outputs.version }}.flatpak
            flatpak run org.storzbickel.app
            ```

            ---

            üìö **Vollst√§ndiges Changelog:** [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/docs/CHANGELOG.md)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
