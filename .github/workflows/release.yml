name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

# Verhindert parallele Builds desselben Tags
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-linux:
    name: Build Linux ${{ matrix.format }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        format: [deb, rpm, appimage]
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.node-version'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci --ignore-scripts

      - name: Build ${{ matrix.format }}
        run: npm run build:${{ matrix.format }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload ${{ matrix.format }} Artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-${{ matrix.format }}
          path: |
            dist/*.${{ matrix.format }}
            dist/*.AppImage
          retention-days: 1

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.node-version'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci --ignore-scripts

      - name: Build Windows
        run: npx electron-builder --win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Windows Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows
          path: |
            dist/*.exe
            dist/*.zip
          retention-days: 1

  build-flatpak:
    name: Build Flatpak Bundle
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Get Version
        id: version
        run: |
          echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          echo "flatpak_version=$(cat .flatpak-runtime-version | tr -d '[:space:]')" >> $GITHUB_OUTPUT

      - name: Cache Flatpak Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.local/share/flatpak
            .flatpak-builder
          key: flatpak-${{ runner.os }}-${{ hashFiles('flatpak/org.storzbickel.app.yml') }}
          restore-keys: |
            flatpak-${{ runner.os }}-

      - name: Setup Flatpak
        run: |
          FLATPAK_VERSION="${{ steps.version.outputs.flatpak_version }}"
          echo "Using Flatpak Version: $FLATPAK_VERSION"
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder
          flatpak remote-add --user --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
          flatpak install --user -y flathub org.freedesktop.Platform//$FLATPAK_VERSION org.freedesktop.Sdk//$FLATPAK_VERSION
          flatpak install --user -y flathub org.electronjs.Electron2.BaseApp//$FLATPAK_VERSION
          flatpak install --user -y flathub org.freedesktop.Sdk.Extension.node22//$FLATPAK_VERSION

      - name: Build Flatpak
        run: |
          flatpak-builder --repo=repo --force-clean build-dir flatpak/org.storzbickel.app.yml
          flatpak build-bundle repo storz-bickel-app-${{ steps.version.outputs.version }}.flatpak org.storzbickel.app

      - name: Upload Flatpak Artifact
        uses: actions/upload-artifact@v4
        with:
          name: flatpak-bundle
          path: '*.flatpak'
          retention-days: 1

  create-release:
    name: Create GitHub Release
    needs: [build-linux, build-windows, build-flatpak]
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Get Version
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Extract Changelog
        id: changelog
        run: |
          # Extrahiere Changelog f√ºr diese Version
          VERSION="${{ steps.version.outputs.version }}"
          CHANGELOG=$(sed -n "/## \[$VERSION\]/,/## \[/p" docs/CHANGELOG.md | sed '$d' | tail -n +2)
          
          # Fallback wenn keine spezifische Version gefunden
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="Siehe [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/master/docs/CHANGELOG.md) f√ºr Details."
          fi
          
          # Speichere f√ºr GitHub Output (escape newlines)
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Download Linux Artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: linux-*
          path: dist/
          merge-multiple: true

      - name: Download Windows Artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: windows
          path: dist/

      - name: Download Flatpak Artifact
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: flatpak-bundle
          path: ./

      - name: Clean up unwanted files
        run: |
          rm -f dist/*.yml dist/*.blockmap dist/*.zip
      
      - name: Delete existing release
        continue-on-error: true
        run: |
          gh release delete v${{ steps.version.outputs.version }} --yes || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          draft: true
          generate_release_notes: false
          files: |
            dist/*.deb
            dist/*.rpm
            dist/*.AppImage
            dist/*.exe
            *.flatpak
          body: |
            ## üéâ Release v${{ steps.version.outputs.version }}

            ### üìù √Ñnderungen

            ${{ steps.changelog.outputs.content }}

            ---

            ### üì¶ Installation

            #### üêß Linux

            **DEB (Debian/Ubuntu)**
            ```bash
            sudo dpkg -i storz-bickel-app_${{ steps.version.outputs.version }}_amd64.deb
            ```

            **RPM (Fedora/RHEL/openSUSE)**
            ```bash
            sudo rpm -i storz-bickel-app-${{ steps.version.outputs.version }}.x86_64.rpm
            # oder auf openSUSE:
            sudo zypper install storz-bickel-app-${{ steps.version.outputs.version }}.x86_64.rpm
            ```

            **AppImage (Universal)**
            ```bash
            chmod +x storz-bickel-app-${{ steps.version.outputs.version }}.AppImage
            ./storz-bickel-app-${{ steps.version.outputs.version }}.AppImage
            ```

            **Flatpak**
            ```bash
            flatpak install storz-bickel-app-${{ steps.version.outputs.version }}.flatpak
            flatpak run org.storzbickel.app
            ```

            #### ü™ü Windows

            > ‚ö†Ô∏è **Hinweis:** Windows-Builds sind ungetestet. Feedback willkommen!

            **Installer (empfohlen)**
            - Lade `Storz-&-Bickel-Setup-${{ steps.version.outputs.version }}.exe` herunter
            - F√ºhre den Installer aus

            **Portable**
            - Lade `Storz-&-Bickel-${{ steps.version.outputs.version }}-portable.exe` herunter
            - Starte die Datei direkt (keine Installation n√∂tig)

            ---

            ### üîµ Web Bluetooth

            Die App unterst√ºtzt Web Bluetooth auf allen Plattformen (Linux & Windows).

            **Windows:** Bluetooth muss im System aktiviert sein.
            **Linux:** Siehe [docs/QUICKSTART.md](https://github.com/${{ github.repository }}/blob/master/docs/QUICKSTART.md) f√ºr Bluetooth-Setup.

            ---

            üìö **Vollst√§ndiges Changelog:** [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/master/docs/CHANGELOG.md)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
